generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id                   String                  @id @default(uuid())
  name                 String
  email                String                  @unique
  phone                String?                 @unique
  isVerified           Boolean                 @default(false)
  createdAt            DateTime                @default(now())
  avatar               String?
  updatedAt            DateTime                @updatedAt
  deletedAt            DateTime?
  managerOfOrganizerId String?
  whatsAppNotification Boolean                 @default(false)
  password             String?
  googleId             String?                 @unique
  provider             String                  @default("local")
  auditLogs            audit_logs[]
  bookings             bookings[]
  ownedOrganizers      event_organizer?        @relation("OwnerOrganizers")
  createdEvents        events[]
  uploadedImages       images[]
  passwordResetTokens  password_reset_tokens[]
  payouts              payouts[]
  refreshTokens        refresh_tokens[]
  reviews              reviews[]
  user_roles           user_roles[]
  managerOfOrganizer   event_organizer?        @relation("OrganizerManagers", fields: [managerOfOrganizerId], references: [id])

  @@index([email])
  @@index([phone])
  @@index([googleId])
}

model event_organizer {
  id          String        @id @default(uuid())
  name        String        @unique
  description String?
  logo        String?
  state       String?
  address     String?
  isVerified  Boolean       @default(false)
  ownerId     String        @unique
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  bankDetails bank_details?
  owner       users         @relation("OwnerOrganizers", fields: [ownerId], references: [id], onDelete: Cascade)
  events      events[]
  images      images[]
  payouts     payouts[]
  reviews     reviews[]
  tours       tours[]
  managers    users[]       @relation("OrganizerManagers")

  @@index([name])
}

model platform_config {
  id                String   @id @default(uuid())
  name              String
  registeredAddress String
  state             String
  city              String
  pincode           String
  gstNumber         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model bank_details {
  id                    String                 @id @default(uuid())
  accountHolder         String
  accountNumber         String
  ifscCode              String
  bankName              String
  verificationStatus    BankVerificationStatus @default(UNVERIFIED)
  verificationTxnId     String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  organizerId           String                 @unique
  lastWebhookEventId    String?
  providerAccountId     String?
  providerBeneficiaryId String?
  providerName          String                 @default("Razerpay")
  organizer             event_organizer        @relation(fields: [organizerId], references: [id])
  payouts               payouts[]

  @@index([accountNumber])
  @@index([verificationStatus])
}

model events {
  id            String           @id @default(uuid())
  title         String
  description   String?
  type          EventType        @default(EXCLUSIVE)
  flyerImage    String?
  eventStatus   EventStatus      @default(UPCOMING)
  publishStatus PublishStatus    @default(DRAFT)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  organizerId   String
  createdById   String
  category      String
  subCategory   String
  TC            Json?
  advisory      Json?
  questions     Json?
  organizerNote String?
  startDate     DateTime?
  endDate       DateTime?
  categories    String[]
  isSponsored   Boolean          @default(false)
  slug          String           @unique
  flyerPublicId String?
  bookings      bookings[]
  artists       event_artists[]
  sponsors      event_sponsors[]
  venues        event_venues[]
  createdBy     users            @relation(fields: [createdById], references: [id])
  organizer     event_organizer  @relation(fields: [organizerId], references: [id])
  images        images[]
  reviews       reviews[]
  tickets       tickets[]
  tour_events   tour_events[]

  @@index([organizerId, createdAt(sort: Desc)])
  @@index([organizerId, publishStatus, createdAt(sort: Desc)])
  @@index([category])
  @@index([category, subCategory])
  @@index([publishStatus])
  @@index([type])
  @@index([startDate])
}

model event_venues {
  id            String   @id @default(uuid())
  name          String
  contact       String?
  email         String?
  fullAddress   String
  city          String
  state         String?
  country       String?
  postalCode    String?
  latitude      Float?
  longitude     Float?
  googlePlaceId String?
  isPrimary     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  eventId       String
  event         events   @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([city])
}

model event_artists {
  id            String   @id @default(uuid())
  name          String
  gender        String?
  image         String?
  instagramLink String?
  spotifyLink   String?
  createdAt     DateTime @default(now())
  eventId       String
  event         events   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tours         tours[]  @relation("TourPrimaryArtist")

  @@index([eventId])
  @@index([name])
}

model tours {
  id              String          @id @default(uuid())
  name            String
  description     String?
  coverImage      String?
  startDate       DateTime?
  endDate         DateTime?
  status          TourStatus      @default(DRAFT)
  organizerId     String
  primaryArtistId String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  coverPublicId   String?
  tour_events     tour_events[]
  organizer       event_organizer @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  primaryArtist   event_artists   @relation("TourPrimaryArtist", fields: [primaryArtistId], references: [id])

  @@index([organizerId, createdAt(sort: Desc)])
  @@index([status])
  @@index([primaryArtistId])
}

model tour_events {
  id        String   @id @default(uuid())
  tourId    String
  eventId   String
  createdAt DateTime @default(now())
  event     events   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tour      tours    @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@unique([tourId, eventId])
  @@index([tourId])
  @@index([eventId])
}

model tickets {
  id             String              @id @default(uuid())
  name           String
  type           TicketType          @default(STANDARD_TICKET)
  entryType      EntryType           @default(SINGLE_ENTRY)
  price          Float?
  totalQty       Int
  soldQty        Int                 @default(0)
  info           String?
  purchaseExpiry DateTime?
  comingSoon     Boolean             @default(false)
  onGroundOnly   Boolean             @default(false)
  maxPerUser     Int?
  gstType        GstType             @default(NONE)
  gstRate        Float?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  eventId        String
  booking_items  booking_items[]
  breakdowns     payment_breakdown[]
  event          events              @relation(fields: [eventId], references: [id])

  @@index([eventId])
  @@index([eventId, createdAt])
}

model bookings {
  id               String          @id @default(uuid())
  totalAmount      Float
  platformFeeTotal Float
  gstTotal         Float
  gstType          GstType         @default(NONE)
  status           BookingStatus   @default(PENDING)
  ticketPdfUrl     String?
  userDetails      Json?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  userId           String
  eventId          String
  booking_items    booking_items[]
  event            events          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user             users           @relation(fields: [userId], references: [id], onDelete: Cascade)
  payment          payments?

  @@index([eventId, status])
  @@index([userId])
  @@index([ticketPdfUrl])
}

model booking_items {
  id          String              @id @default(uuid())
  quantity    Int
  ticketPrice Float
  subtotal    Float
  platformFee Float
  gstAmount   Float
  totalAmount Float
  createdAt   DateTime            @default(now())
  bookingId   String
  ticketId    String
  checkedIn   Boolean             @default(false)
  checkedInAt DateTime?
  checkedInBy String?
  qrCode      String?             @unique
  qrCodeData  String?
  booking     bookings            @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  ticket      tickets             @relation(fields: [ticketId], references: [id])
  breakdowns  payment_breakdown[]

  @@index([bookingId])
  @@index([ticketId])
  @@index([qrCode])
  @@index([checkedIn])
}

model payments {
  id            String              @id @default(uuid())
  amount        Float
  status        PaymentStatus       @default(PENDING)
  paymentMethod String?
  transactionId String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  bookingId     String              @unique
  breakdowns    payment_breakdown[]
  booking       bookings            @relation(fields: [bookingId], references: [id])
  refund        refunds?
}

model refunds {
  id               String       @id @default(uuid())
  paymentId        String       @unique
  amountCents      Int
  reason           String?
  status           RefundStatus @default(REQUESTED)
  providerRefundId String?
  processedAt      DateTime?
  createdAt        DateTime     @default(now())
  payment          payments     @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([status])
}

model payment_breakdown {
  id             String         @id @default(uuid())
  ticketName     String
  ticketPrice    Float
  quantity       Int
  gstAmount      Float
  platformFee    Float
  otherDeduction Float?
  totalPayout    Float
  createdAt      DateTime       @default(now())
  ticketId       String
  paymentId      String
  bookingItemId  String?
  booking_item   booking_items? @relation(fields: [bookingItemId], references: [id])
  payment        payments       @relation(fields: [paymentId], references: [id])
  ticket         tickets        @relation(fields: [ticketId], references: [id])
}

model payouts {
  id               String          @id @default(uuid())
  amount           Float
  status           PayoutStatus    @default(PENDING)
  payoutDate       DateTime?
  remarks          String?
  createdAt        DateTime        @default(now())
  organizerId      String
  userId           String
  bankDetailsId    String
  failureReason    String?
  providerBatchId  String?
  providerPayoutId String?
  bank_details     bank_details    @relation(fields: [bankDetailsId], references: [id])
  organizer        event_organizer @relation(fields: [organizerId], references: [id])
  user             users           @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model images {
  id                 String           @id @default(uuid())
  url                String
  type               ImageType
  uploadedAt         DateTime         @default(now())
  eventId            String?
  organizerId        String?
  userId             String?
  cloudinaryPublicId String?
  event              events?          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  organizer          event_organizer? @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  user               users?           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([eventId, uploadedAt(sort: Desc)])
  @@index([type])
  @@index([cloudinaryPublicId])
}

model sponsors {
  id             String           @id @default(uuid())
  name           String
  logoUrl        String?
  websiteUrl     String?
  primaryColor   String?
  secondaryColor String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  events         event_sponsors[]

  @@index([name])
}

model event_sponsors {
  id        String   @id @default(uuid())
  eventId   String
  sponsorId String
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  event     events   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  sponsor   sponsors @relation(fields: [sponsorId], references: [id], onDelete: Cascade)

  @@unique([eventId, sponsorId])
  @@index([eventId, isPrimary])
  @@index([sponsorId])
}

model reviews {
  id          String           @id @default(uuid())
  userId      String
  eventId     String?
  organizerId String?
  rating      Int
  title       String?
  comment     String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  event       events?          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  organizer   event_organizer? @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  user        users            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@unique([userId, organizerId])
  @@index([organizerId])
}

model otps {
  id        String   @id @default(uuid())
  email     String
  code      String
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model password_reset_tokens {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model refresh_tokens {
  id         String   @id @default(uuid())
  userId     String
  tokenHash  String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  revoked    Boolean  @default(false)
  replacedBy String?
  user       users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([tokenHash])
}

model audit_logs {
  id           String   @id @default(uuid())
  actorId      String?
  actorType    String?
  action       String
  resourceId   String?
  resourceType String?
  before       Json?
  after        Json?
  ip           String?
  userAgent    String?
  createdAt    DateTime @default(now())
  actor        users?   @relation(fields: [actorId], references: [id])
}

model roles {
  id         String       @id @default(uuid())
  name       Roles        @unique
  user_roles user_roles[]
}

model user_roles {
  id     String @id @default(uuid())
  userId String
  roleId String
  roles  roles  @relation(fields: [roleId], references: [id], onDelete: Cascade)
  users  users  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
}

enum EventStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
}

enum PublishStatus {
  DRAFT
  PUBLISHED
  PENDING
}

enum EventType {
  GUESTLIST
  EXCLUSIVE
  NON_EXCLUSIVE
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ImageType {
  EVENT
  EVENT_GALLERY
  ORGANIZER
}

enum TicketType {
  GUESTLIST
  STANDARD_TICKET
  TABLE_TICKET
  GROUP_TICKET
}

enum EntryType {
  SINGLE_ENTRY
  COUPLE_ENTRY
}

enum GstType {
  NONE
  CGST_SGST
  IGST
  OTHER_CGST_SGST
  OTHER_IGST
}

enum RefundStatus {
  REQUESTED
  APPROVED
  DECLINED
  PROCESSED
  FAILED
}

enum BankVerificationStatus {
  UNVERIFIED
  VERIFICATION_IN_PROGRESS
  VERIFIED
  FAILED
}

enum Roles {
  USER
  ORGANIZER
  MANAGER
  ADMIN
}

enum TourStatus {
  DRAFT
  PUBLISHED
}
